require './cg_config.rb'

preprocess do
  Toc.instance.prepare @items, SECTION_CONFIG
end

compile '/bootstrap/**/*' do
  nil
end

compile '/content/scripts/**/*' do
  nil
end

compile '/tipuesearch/**/*' do
  nil
end

#compile "/tipuesearch_logic/tipuesearch_content.js.erb" do |file|
#  filter :erb
#end

compile '/**/*.md.erb' do
  filter :erb
  filter :kramdown
  layout '/course.*'
end

compile '/**/*' do
  if item.binary? || item[:status] == "hidden"
    nil
  end
end

route '/bootstrap/**/*' do
  @item.identifier.to_s
end

route '/tipuesearch/**/*' do
  @item.identifier.to_s
end

route "/tipuesearch_logic/tipuesearch_content.*" do
  '/tipuesearch/tipuesearch_content.js'
end

# Output the search page
route '/tipuesearch_logic/search.md.erb' do
  '/tipuesearch_logic/search/index.html'
end

# Select which .md.erb becomes the home page of the site
route '/content/pages/01_intro.md.erb' do
  '/index.html'
end

route '/**/*' do
  if item[:extension].nil?
    raise RuntimeError, "Missing required extension: \".#{item.identifier}\""
  elsif item.binary?
    item.identifier.to_s
  elsif item.identifier == "/search_logic/tipuesearch_content/"
    item.identifier.chop + '.' + item[:extension] rescue fail "in route * in Rules"
  elsif item[:status] == "hidden"
    nil
  elsif item[:type] == "subsection"
    nil
  elsif item[:extension] != "css"
    item.identifier.without_ext + '/index.html'
  end
end

layout '/**/*', :erb
